default:
  image: node:22
  cache: &global_cache
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules
    policy: pull

.pnpm_before_script: &pnpm_before_script
  - npm i -g pnpm
  - pnpm config set store-dir .pnpm-store

stages:
  - cache_dependencies
  - audit
  - build
  - release
  - deploy

install:
  stage: cache_dependencies
  interruptible: true
  before_script: *pnpm_before_script
  script:
    - pnpm install --frozen-lockfile
  cache:
    <<: *global_cache
    policy: pull-push
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - when: always
  needs: []

audit:
  stage: audit
  interruptible: true
  before_script: *pnpm_before_script
  script:
    - pnpm lint
    - pnpm test
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - when: always
  needs:
    - install

build:
  image: node:22
  stage: build
  interruptible: true
  before_script: *pnpm_before_script
  script:
    - pnpm build
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - when: always
  needs:
    - install
    - audit

release:
  stage: release
  before_script: *pnpm_before_script
  script:
    - pnpm release
  variables:
    GITLAB_TOKEN: $GITLAB_TOKEN
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - if: '$CI_COMMIT_TAG'
      when: never
  needs:
    - install
    - audit
    - build

build_image:
  image: docker:latest
  stage: build
  interruptible: true
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  script:
    - export IMAGE_TAG="yongchenglow-$CI_COMMIT_TAG"
    - docker build --platform linux/arm64 -t "$CI_REGISTRY_IMAGE:$IMAGE_TAG" .
    - docker push "$CI_REGISTRY_IMAGE:$IMAGE_TAG"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - if: '$CI_COMMIT_TAG'
      when: never

deploy:
  stage: deploy
  image: bitnami/kubectl-helm:latest
  script:
    - echo "$KUBECONFIG_B64" | base64 -d > kubeconfig.yaml
    - export KUBECONFIG=$PWD/kubeconfig.yaml
    - export IMAGE_TAG="yongchenglow-$CI_COMMIT_TAG"
    - helm upgrade --install "$RELEASE_NAME" ./chart \
      --namespace "$KUBE_NAMESPACE" \
      --create-namespace \
      --set image.tag="$IMAGE_TAG"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - if: '$CI_COMMIT_TAG'
      when: never
  needs:
    - build_image
